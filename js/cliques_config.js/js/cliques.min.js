"use strict";function urlify(a){var b=/(^|\s)((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)/gi,c=new RegExp(b);return a.replace(c,function(a){return'<a href="'+a+'">'+a+"</a>"})}function highlight(a,b){return a=a.insert(a.indexOf(b)-1,'<span class="highlight">'),a.insert(a.indexOf(b)+b.length,"</span>")}function removeChatIfAlreadyExists(a,b){var c=b.filter(function(b){return b.id!=a.id});return c}function youtube_url_to_id(a){if(a){var b=a.split("v=")[1];if(b){var c=b.indexOf("&");return-1!=c&&(b=b.substring(0,c)),b}}}angular.module("cliques_config",[]).constant("ENV","development").constant("BACKEND_SERVER","http://127.0.0.1:8080/api/v1/");var app=angular.module("cliques",["ngCookies","ngResource","ngRoute","infinite-scroll","mm.foundation","cliques_config","post_controllers"]);app.config(["$routeProvider",function(a){a.when("/posts",{templateUrl:"templates/posts.html",controller:"PostListCtrl"}).when("/posts/:postId",{templateUrl:"templates/post_detail.html",controller:"PostDetailCtrl"}).when("/new_post",{templateUrl:"templates/new_post.html",controller:"NewPostCtrl"}).when("/login",{templateUrl:"templates/login.html",controller:"AuthCtrl"}).when("/chat",{templateUrl:"templates/chat.html",controller:"ChatCtrl"}).when("/users/:username",{templateUrl:"templates/profile.html",controller:"UserCtrl"}).when("/polls",{templateUrl:"templates/polls.html",controller:"PollListCtrl"}).when("/polls/:pollStub",{templateUrl:"templates/poll.html",controller:"PollDetailCtrl"}).when("/notifications",{templateUrl:"templates/notifications.html",controller:"NotificationCtrl"}).otherwise({redirectTo:"/posts"})}]).config(function(a){a.resourceUrlWhitelist(["self","http://**.youtube.com/**"])}).config(["$httpProvider",function(a){a.defaults.xsrfCookieName="csrftoken",a.defaults.xsrfHeaderName="X-CSRFToken"}]).constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).service("Session",function(){return this.create=function(a){this.id=a,this.username=username},this.destroy=function(){this.id=null,this.username=null,token=null},this}).factory("Notification",function(a,b,c,d){var e={};return e.notifications=[],e.remove_all=function(){for(var b=0;b<e.notifications.length;b++){var c=e.notifications[b];a.delete(d+"notifications/"+c.id+"/")}e.notifications.splice(0,e.notifications.length+1)},e.remove_notification=function(b){console.log("notification remove",b),a.delete(d+"notifications/"+b.id+"/").success(function(){console.log("removed notification",b.id);for(var a=0;a<e.notifications.length;a++)if(e.notifications[a].id==b.id){e.notifications.splice(a,1);break}})},a.get(d+"notifications/").success(function(a){console.log("note results",a),a.results.forEach(function(a){e.notifications.push(a)})}),b.$on("notification",function(a,b){e.notifications.push(b)}),b.$on("$routeUpdate",function(){console.log("remove notifications")}),e}).factory("User",function(a,b,c,d){function e(){var a=new Date,b=6e4;f.connected_users=[],f.users.forEach(function(c){console.log("connected user?",c,a,a-Date.parse(c.last_updated)),a-Date.parse(c.last_updated)<b&&(console.log("user is connected",c),f.connected_users.push(c))}),c.$apply(),console.log("Users.connected_users",f.connected_users)}var f={};f.users=[],f.connected_users=[],f.get_users=function(){return f.users==[]?void 0:f.users};{var g=function(){a.get(d+"users/").success(function(a){console.log("users list",a),f.users=[],a.results.forEach(function(a){f.users.push(a)}),console.log("users.users",f.users),e()})},h=function(){a.post(d+"check_in/",{}).success(function(a){console.log("checked in",a),g()})};b(function(){console.log("interval"),h()},15e3)}return h(),console.log("connected",f),f}).factory("Chat",function(a,b,c,d,e,f){var g={};g.messages=[],g.messages=d.stream,g.connected_users=[],g.session=d.session,console.log("Chat init",g);({id:g.session.id});return a.get(f+"chat/messages/").success(function(a){console.log("messages results",a),a.results.reverse().forEach(function(a){g.messages.push(a)})}),b.$on("chat",function(a,b){g.messages.push(b)}),g}).factory("Channel",function(a,b,c){var d={};d.stream=[],d.session={};var e=function(b){b=angular.fromJson(b.data),a.$apply(function(){console.log("message callback",b.type,b.data),b&&(console.log("broadcast",b.type,b.data),a.$broadcast(b.type,b.data))})},f=function(a,b){var c=this;this.socketCreationCallback=function(a){console.log("token",a);var b=new goog.appengine.Channel(a);c.channelId=b.channelId;var d=b.open();d.onerror=function(a){console.log("Channel error",a)},d.onclose=function(){console.log("Channel closed")},d.onmessage=e,c.channelSocket=d},this.socketCreationCallback(b.session_key)};return d.session=b.post(c+"push/",{}).success(function(a){return console.log("new session created",a),a}),d.session.then(function(a){new f(c,a.data,e)}),d}),app.run(function(a,b,c){localStorage.getItem("token")?(b.defaults.headers.common.Authorization="Token "+localStorage.getItem("token"),a.loggedIn=!0):a.loggedIn=!1,a.$watch(function(){return c.path()},function(b){0==a.loggedIn&&"/login"!=b&&c.path("/login")})}),app.run(function(){}),app.run(function(){}),String.prototype.insert=function(a,b){return a>0?this.substring(0,a)+b+this.substring(a,this.length):b+this},angular.module("post_controllers",[]).controller("UserCtrl",function(a,b,c,d){var e=localStorage.getItem("username");c.get(d+"users/"+e+"/").then(function(b){console.log("user result",b),a.user=b.data})}).controller("UsersCtrl",function(a,b,c,d,e){a.$watch(function(){a.users=e.users,a.connected_users=e.connected_users})}).controller("PostListCtrl",function(a,b,c,d){var e=1,f=!1;a.posts=[];var g=function(c){console.log("add pages",c),f=!0,void 0==c&&(c=1),b.get(d+"posts/?page="+c).then(function(b){b.data.results.forEach(function(b){b.youtube=youtube_url_to_id(b.url),a.posts.push(b)}),console.log(a.posts),e=c,f=!1,a.$apply()})};a.scroll=function(){return f?void console.log("attempted scroll"):(g(e+1),void console.log("scroll!"))},a.trustSrc=function(a){return c.trustAsResourceUrl(a)},g(1),console.log("post list auth",b.defaults.headers.common.Authorization)}).directive("media",function(){return{restrict:"E",transclude:!0,replace:!1,templateUrl:"partials/media.html"}}).directive("post",function(){return{restrict:"E",transclude:!0,replace:!1,templateUrl:"partials/post.html"}}).directive("comment",function(){return{restrict:"E",transclude:!0,replace:!1,templateUrl:"partials/comment.html"}}).controller("PostDetailCtrl",function(a,b,c,d,e,f,g){a.postId=e.postId,b.get(g+"posts/"+a.postId+"/").then(function(b){a.post=b.data,a.post.youtube=youtube_url_to_id(a.post.url)});var h=function(){},i=function(a,b,c,d){console.log("error",b),a.status=c+" "+d};a.new_comment_submit=function(){a.formData.post=a.postId,console.log("submitting",a.formData,this),b({url:g+"posts/"+a.postId+"/comments/",method:"POST",data:$.param(a.formData),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Authorization:"Token "+localStorage.getItem("token")}}).success(h).error(i),a.formData="",d.reload()},a.trustSrc=function(a){return c.trustAsResourceUrl(a)}}).controller("AuthCtrl",function(a,b,c,d,e,f,g,h,i){a.credentials={username:"",password:""},a.login=function(a){h.setCredentials(b,i,a),c.path("/posts").replace(),console.log("pathed")},a.logout=function(){h.clearCredentials(),c.path("/login").replace()},localStorage.getItem("token")&&c.path("/posts").replace()}).filter("DTSince",function(){return function(a){var b=new Date,c=(b-Date.parse(a))/1e3;return 10>c?"A few seconds ago":60>c?Math.floor(c)+" seconds ago":3600>c?Math.floor(c/60)+" minutes ago":86400>c?Math.floor(c/3600)+" hours ago":2592e3>c?Math.floor(c/86400)+" days ago":7776e4>c?Math.floor(c/2592e3)+" months ago":93312e4>c?Math.floor(c/7776e4)+" years ago":93312e5>c?Math.floor(c/93312e4)+" decades ago":void 0}}).factory("httpInterceptor",function(a,b,c){return function(b){console.log("http intercepted");var d=function(a){return a},e=function(b){return 401===b.status&&c.path("/#/login"),a.reject(b)};return b.then(d,e)}}).factory("authorization",function(a){var b="http://127.0.0.1:8080";return{login:function(c){return a.post(b+"/api/token/",c)}}}).factory("api",function(a,b){return{init:function(c){a.defaults.headers.common["X-Access-Token"]=c||b.token}}}).factory("AuthService",function(a,b,c){return{login:function(b){return a.get("http://127.0.0.1:8080/api/cookie/").then(a.post("http://127.0.0.1:8080/auth/login/",b).then(function(a){c.create(a.id,a.username,a.token)}))},isAuthenticated:function(){return!!c.userId}}}).factory("Auth",["Base64","$http","$rootScope","$location","BACKEND_SERVER",function(a,b,c,d){b.defaults.headers.common.Authorization="Token "+localStorage.getItem("token");var e=function(a){console.log("authdata",a);var e=a.token;localStorage.setItem("token",e),localStorage.setItem("username",a.username),b.defaults.headers.common.Authorization="Token "+e,c.loggedIn=!0,d.path("/posts")},f=function(a,b,c){console.log("login error",b,c)};return{setCredentials:function(c,d,g){var h=a.encode(g.username+":"+g.password);console.log("encoded",h,d+"token/"),b({url:d+"token/",method:"GET",headers:{Authorization:"Basic "+h}}).success(e).error(f)},clearCredentials:function(){document.execCommand("ClearAuthenticationCache"),localStorage.removeItem("token"),b.defaults.headers.common.Authorization="Basic ",c.loggedIn=!1}}}]).factory("Base64",function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(b){var c,d,e,f,g,h="",i="",j="",k=0;do c=b.charCodeAt(k++),d=b.charCodeAt(k++),i=b.charCodeAt(k++),e=c>>2,f=(3&c)<<4|d>>4,g=(15&d)<<2|i>>6,j=63&i,isNaN(d)?g=j=64:isNaN(i)&&(j=64),h=h+a.charAt(e)+a.charAt(f)+a.charAt(g)+a.charAt(j),c=d=i="",e=f=g=j="";while(k<b.length);return h},decode:function(b){var c,d,e,f,g,h="",i="",j="",k=0,l=/[^A-Za-z0-9\+\/\=]/g;l.exec(b)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=a.indexOf(b.charAt(k++)),f=a.indexOf(b.charAt(k++)),g=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),c=e<<2|f>>4,d=(15&f)<<4|g>>2,i=(3&g)<<6|j,h+=String.fromCharCode(c),64!=g&&(h+=String.fromCharCode(d)),64!=j&&(h+=String.fromCharCode(i)),c=d=i="",e=f=g=j="";while(k<b.length);return h}}}).controller("NewPostCtrl",function(a,b,c,d,e){c.get(e+"categories/").success(function(b){console.log("categories",b),a.cats=b}),a.formData={},a.new_post_submit=function(){console.log("submitting",a.formData),c({url:e+"posts/",method:"POST",data:$.param(a.formData),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Authorization:"Token "+localStorage.getItem("token")}}).success(function(){console.log("new post"),d.path("/#/posts").replace()}).error(function(a,b,c,d){console.log("error",b),a.status=c+" "+d})}}).controller("ProfileCtrl",function(){}).controller("ChatCtrl",function(a,b,c,d){a.messages=[],a.messages=c.messages,c.session.success(function(b){a.session=b}),a.$watch(function(){var a=$("#chat_messages");a.scrollTop(a[0].scrollHeight)}),a.send_message=function(){console.log(a.text,a.session),b({method:"POST",url:d+"chat/messages/",data:{message:a.text}}),a.text=""}}).filter("ChatMessageFilter",function(){return function(a){return a.replace("\n","<br/>")}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter,{event:b})}),b.preventDefault())})}}).directive("chat",function(){return{restrict:"E",transclude:!0,replace:!1,templateUrl:"partials/chat.html"}}).controller("PollListCtrl",function(a){$http.get(a+"polls/").then(function(a){$scope.polls=a.data.results})}).controller("PollDetailCtrl",function(a,b,c,d,e){a.pollStub=c.pollStub,console.log("/#/polls/"+a.pollStub),a.new_submission_submit=function(){a.formData.poll=a.poll.id,console.log("submitting",a.formData,this,a.poll),b({url:e+"polls/"+a.pollStub+"/submissions/",method:"POST",data:$.param(a.formData),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Authorization:"Token "+localStorage.getItem("token")}}).success(function(){console.log("new post"),d.path("/#/polls/"+a.pollStub)}).error(function(a,b,c,d){console.log("error",b),a.status=c+" "+d})},a.removeVote=function(a){console.log("removeVote"),b({url:e+"votes/"+a+"/",method:"DELETE",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Authorization:"Token "+localStorage.getItem("token")}}).success(function(a){console.log("vote killed",a)}).error(function(a,b){console.log("error",b)})},a.addVote=function(c){console.log("addVote");var d={submission:c,user:a.user.id};console.log("submitting",d),b({url:e+"votes/",method:"POST",data:$.param(d),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Authorization:"Token "+localStorage.getItem("token")}}).success(function(a){consol.log("new vote",a)}).error(function(a,b){console.log("error",b)})},b.get(e+"polls/"+a.pollStub+"/").then(function(b){console.log("poll results",b),a.poll=b.data})}).controller("InviteCtrl",function(){$scope.invite_submit=function(){console.log("submitting",$scope.formData,$rootScope.basic_authorization),$http({url:BACKEND_SERVER+"invite/",method:"POST",data:$.param($scope.formData),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Authorization:"Token "+localStorage.getItem("token")}}).success(function(a){a.path("/#/posts")}).error(function(a,b,c,d){console.log("error",b),a.status=c+" "+d})}}).controller("NotificationCtrl",function(a,b,c){a.notifications=[],a.notifications=c.notifications,a.remove_all=function(){c.remove_all(),a.notifications=c.notifications},a.remove_notification=function(a){c.remove_notification(a)}}).controller("TabCtrl",function(a,b,c){a.tabs=[{name:"Posts",link:"/#/posts",alert:""},{name:"Notifications",link:"/#/notifications",alert:""},{name:"Chat",link:"/#/chat",alert:a.chat_count},{name:"BotD",link:"/#/polls/BotD",alert:""},{name:"Profile",link:"/#/profile",alert:""}];var d="/#"+b.path();a.tabs.forEach(function(b){b.link==d&&(a.selected=b)}),a.select=function(b){a.selected=b},a.itemClass=function(b){return b===a.selected?"active":void 0},a.$on("$routeUpdate",function(){console.log("route update")}),a.chat_count=c.stream.length}).controller("OffCanvasDemoCtrl",function(){});